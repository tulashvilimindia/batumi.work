# batumi.work - Georgia JobBoard
# Created: January 19, 2026
# SSL: Self-signed cert for Cloudflare origin (Cloudflare handles public SSL)

# Rate limiting zones
limit_req_zone $binary_remote_addr zone=batumi_attack_limit:10m rate=10r/m;
limit_req_zone $binary_remote_addr zone=batumi_api_limit:10m rate=60r/m;
limit_req_zone $binary_remote_addr zone=batumi_attack_lockout:10m rate=1r/m;
limit_req_zone $binary_remote_addr zone=batumi_attack_ban_2day:10m rate=1r/m;

# HTTP server - redirect to HTTPS
server {
    listen 80;
    listen [::]:80;
    server_name batumi.work www.batumi.work;
    return 301 https://batumi.work$request_uri;
}

# HTTPS server for www - redirect to non-www
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name www.batumi.work;

    ssl_certificate /etc/ssl/certs/batumi.work.crt;
    ssl_certificate_key /etc/ssl/private/batumi.work.key;
    ssl_protocols TLSv1.2 TLSv1.3;

    return 301 https://batumi.work$request_uri;
}

# Main HTTPS server
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name batumi.work;

    ssl_certificate /etc/ssl/certs/batumi.work.crt;
    ssl_certificate_key /etc/ssl/private/batumi.work.key;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;

    # Security headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;

    # Block known attack patterns with 2-day cooldown
    location ~ /(wp-|wordpress|xmlrpc|phpmyadmin|\.env|\.git|\.aws|\.boto|\.s3cfg|\.DS_Store) {
        limit_req zone=batumi_attack_ban_2day burst=1 nodelay;
        limit_req zone=batumi_attack_lockout burst=60 nodelay;
        limit_req zone=batumi_attack_limit burst=5 nodelay;
        access_log /var/log/nginx/batumi.work.attacks.log;
        return 444;
    }

    # Block suspicious user agents
    if ($http_user_agent ~* (sqlmap|nikto|nmap|masscan|metasploit|burp|acunetix|nessus|openvas|vega|w3af|havij)) {
        return 444;
    }

    # API requests - redirect /api/ to /api/v1/
    location = /api/ {
        return 301 /api/v1/jobs;
    }

    location = /api {
        return 301 /api/v1/jobs;
    }

    location /api/ {
        limit_req zone=batumi_api_limit burst=20 nodelay;
        proxy_pass http://127.0.0.1:8101/api/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # V2 Frontend - New React App (jobsNGUI)
    location /v2 {
        proxy_pass http://127.0.0.1:20002/v2;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # V4 Frontend - Adjarian Folk Edition (adjarianJobsNGUI)
    location /v4 {
        proxy_pass http://127.0.0.1:8105/v4;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # V5 Frontend - Enhanced Edition (v5JobsNGUI)
    location /v5 {
        proxy_pass http://127.0.0.1:8106/v5;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # Favicon - serve from existing WordPress theme
    location /favicon.ico {
        alias /var/www/batumi-prod/wp-content/themes/batumi-theme/favicon.svg;
        access_log off;
        log_not_found off;
    }

    # Health check
    location /health {
        proxy_pass http://127.0.0.1:8101/health;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # API docs
    location /docs {
        proxy_pass http://127.0.0.1:8101/docs;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    location /openapi.json {
        proxy_pass http://127.0.0.1:8101/openapi.json;
        proxy_set_header Host $host;
    }

    location /redoc {
        proxy_pass http://127.0.0.1:8101/redoc;
        proxy_set_header Host $host;
    }

    # Static frontend (everything else)
    location / {
        proxy_pass http://127.0.0.1:8100/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;
    }

    # Logs
    access_log /var/log/nginx/batumi.work.access.log;
    error_log /var/log/nginx/batumi.work.error.log;
}
