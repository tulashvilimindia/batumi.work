<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Batumi.work Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <style>
        [x-cloak] { display: none !important; }
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #3498db; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-100" x-data="adminApp()" x-init="init()">
    <div class="flex h-screen">
        <!-- Sidebar -->
        <aside class="w-64 bg-gray-800 text-white flex flex-col">
            <div class="p-4 border-b border-gray-700">
                <h1 class="text-xl font-bold">Batumi.work</h1>
                <p class="text-gray-400 text-sm">Admin Dashboard</p>
            </div>
            <nav class="flex-1 p-4">
                <ul class="space-y-2">
                    <li>
                        <button @click="currentPage = 'dashboard'" :class="currentPage === 'dashboard' ? 'bg-gray-700' : ''" class="w-full text-left px-4 py-2 rounded hover:bg-gray-700 flex items-center">
                            <span class="mr-3">üìä</span> Dashboard
                        </button>
                    </li>
                    <li>
                        <button @click="currentPage = 'jobs'" :class="currentPage === 'jobs' ? 'bg-gray-700' : ''" class="w-full text-left px-4 py-2 rounded hover:bg-gray-700 flex items-center">
                            <span class="mr-3">üíº</span> Jobs
                        </button>
                    </li>
                    <li>
                        <button @click="currentPage = 'parser'" :class="currentPage === 'parser' ? 'bg-gray-700' : ''" class="w-full text-left px-4 py-2 rounded hover:bg-gray-700 flex items-center">
                            <span class="mr-3">üîÑ</span> Parser
                        </button>
                    </li>
                    <li>
                        <button @click="currentPage = 'analytics'" :class="currentPage === 'analytics' ? 'bg-gray-700' : ''" class="w-full text-left px-4 py-2 rounded hover:bg-gray-700 flex items-center">
                            <span class="mr-3">üìà</span> Analytics
                        </button>
                    </li>
                    <li>
                        <button @click="currentPage = 'backups'" :class="currentPage === 'backups' ? 'bg-gray-700' : ''" class="w-full text-left px-4 py-2 rounded hover:bg-gray-700 flex items-center">
                            <span class="mr-3">üíæ</span> Backups
                        </button>
                    </li>
                    <li>
                        <button @click="currentPage = 'database'" :class="currentPage === 'database' ? 'bg-gray-700' : ''" class="w-full text-left px-4 py-2 rounded hover:bg-gray-700 flex items-center">
                            <span class="mr-3">üóÑÔ∏è</span> Database
                        </button>
                    </li>
                    <li>
                        <button @click="currentPage = 'logs'" :class="currentPage === 'logs' ? 'bg-gray-700' : ''" class="w-full text-left px-4 py-2 rounded hover:bg-gray-700 flex items-center">
                            <span class="mr-3">üìù</span> Logs
                        </button>
                    </li>
                </ul>
            </nav>
            <div class="p-4 border-t border-gray-700 text-sm text-gray-400">
                <div class="flex items-center">
                    <span class="w-2 h-2 rounded-full mr-2" :class="health === 'healthy' ? 'bg-green-500' : 'bg-red-500'"></span>
                    <span x-text="health"></span>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 overflow-auto">
            <!-- Dashboard Page -->
            <div x-show="currentPage === 'dashboard'" x-cloak class="p-6">
                <h2 class="text-2xl font-bold mb-6">Dashboard</h2>

                <div x-show="loading" class="flex justify-center py-8"><div class="loader"></div></div>

                <div x-show="!loading && dashboard" class="space-y-6">
                    <!-- Stats Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <div class="bg-white rounded-lg shadow p-6">
                            <div class="text-gray-500 text-sm">Total Jobs</div>
                            <div class="text-3xl font-bold" x-text="dashboard?.stats?.total_jobs || 0"></div>
                        </div>
                        <div class="bg-white rounded-lg shadow p-6">
                            <div class="text-gray-500 text-sm">Active Jobs</div>
                            <div class="text-3xl font-bold text-green-600" x-text="dashboard?.stats?.active_jobs || 0"></div>
                        </div>
                        <div class="bg-white rounded-lg shadow p-6">
                            <div class="text-gray-500 text-sm">Jobs Today</div>
                            <div class="text-3xl font-bold text-blue-600" x-text="dashboard?.stats?.jobs_today || 0"></div>
                        </div>
                        <div class="bg-white rounded-lg shadow p-6">
                            <div class="text-gray-500 text-sm">With Salary</div>
                            <div class="text-3xl font-bold text-purple-600" x-text="dashboard?.stats?.jobs_with_salary || 0"></div>
                        </div>
                    </div>

                    <!-- Quick Info -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="bg-white rounded-lg shadow p-6">
                            <h3 class="font-bold mb-4">Jobs by Region</h3>
                            <div class="space-y-2">
                                <template x-for="region in (dashboard?.by_region || []).slice(0, 5)" :key="region.lid">
                                    <div class="flex justify-between">
                                        <span class="text-gray-600" x-text="'LID ' + region.lid"></span>
                                        <span class="font-semibold" x-text="region.count"></span>
                                    </div>
                                </template>
                            </div>
                        </div>
                        <div class="bg-white rounded-lg shadow p-6">
                            <h3 class="font-bold mb-4">Jobs by Category</h3>
                            <div class="space-y-2">
                                <template x-for="cat in (dashboard?.by_category || []).slice(0, 5)" :key="cat.cid">
                                    <div class="flex justify-between">
                                        <span class="text-gray-600" x-text="'CID ' + cat.cid"></span>
                                        <span class="font-semibold" x-text="cat.count"></span>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>

                    <!-- System Info -->
                    <div class="bg-white rounded-lg shadow p-6">
                        <h3 class="font-bold mb-4">System Status</h3>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                            <div>
                                <span class="text-gray-500">Parser Last Run:</span>
                                <div x-text="dashboard?.parser?.last_run || 'Never'"></div>
                            </div>
                            <div>
                                <span class="text-gray-500">Backups:</span>
                                <div x-text="(dashboard?.backup?.count || 0) + ' files'"></div>
                            </div>
                            <div>
                                <span class="text-gray-500">Regions:</span>
                                <div x-text="dashboard?.stats?.total_regions || 0"></div>
                            </div>
                            <div>
                                <span class="text-gray-500">Categories:</span>
                                <div x-text="dashboard?.stats?.total_categories || 0"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Jobs Page -->
            <div x-show="currentPage === 'jobs'" x-cloak class="p-6">
                <h2 class="text-2xl font-bold mb-6">Jobs</h2>

                <!-- Filters -->
                <div class="bg-white rounded-lg shadow p-4 mb-6">
                    <div class="flex flex-wrap gap-4">
                        <input type="text" x-model="jobFilters.q" @input.debounce.300ms="loadJobs()" placeholder="Search..." class="border rounded px-3 py-2">
                        <select x-model="jobFilters.status" @change="loadJobs()" class="border rounded px-3 py-2">
                            <option value="">All Status</option>
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                            <option value="expired">Expired</option>
                        </select>
                        <select x-model="jobFilters.cid" @change="loadJobs()" class="border rounded px-3 py-2">
                            <option value="">All Categories</option>
                            <option value="1">Administration (1)</option>
                            <option value="2">Sales (2)</option>
                            <option value="3">Finance (3)</option>
                            <option value="6">IT (6)</option>
                            <option value="8">Medicine (8)</option>
                        </select>
                    </div>
                </div>

                <div x-show="loading" class="flex justify-center py-8"><div class="loader"></div></div>

                <div x-show="!loading" class="bg-white rounded-lg shadow overflow-hidden">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-sm font-semibold">Title</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold">Company</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold">Status</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold">CID/LID</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y">
                            <template x-for="job in jobs.items || []" :key="job.id">
                                <tr class="hover:bg-gray-50">
                                    <td class="px-4 py-3">
                                        <div class="font-medium" x-text="job.title_ge?.substring(0, 50) + '...'"></div>
                                        <div class="text-xs text-gray-500" x-text="job.parsed_from"></div>
                                    </td>
                                    <td class="px-4 py-3 text-sm" x-text="job.company_name || '-'"></td>
                                    <td class="px-4 py-3">
                                        <span class="px-2 py-1 text-xs rounded-full" :class="job.status === 'active' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'" x-text="job.status"></span>
                                    </td>
                                    <td class="px-4 py-3 text-sm" x-text="job.jobsge_cid + '/' + job.jobsge_lid"></td>
                                    <td class="px-4 py-3">
                                        <button @click="toggleJobStatus(job)" class="text-blue-600 hover:underline text-sm mr-2">Toggle</button>
                                        <button @click="deleteJob(job.id)" class="text-red-600 hover:underline text-sm">Delete</button>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>

                    <!-- Pagination -->
                    <div class="px-4 py-3 bg-gray-50 flex justify-between items-center">
                        <span class="text-sm text-gray-600" x-text="'Total: ' + (jobs.total || 0)"></span>
                        <div class="flex gap-2">
                            <button @click="jobFilters.page--; loadJobs()" :disabled="jobFilters.page <= 1" class="px-3 py-1 border rounded disabled:opacity-50">Prev</button>
                            <span class="px-3 py-1" x-text="'Page ' + jobFilters.page"></span>
                            <button @click="jobFilters.page++; loadJobs()" :disabled="jobFilters.page >= jobs.pages" class="px-3 py-1 border rounded disabled:opacity-50">Next</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Parser Page -->
            <div x-show="currentPage === 'parser'" x-cloak class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">Parser Management</h2>
                    <div class="flex gap-2">
                        <button @click="loadParserProgress()" class="bg-gray-200 px-3 py-2 rounded hover:bg-gray-300 text-sm">Refresh</button>
                        <button @click="showTriggerModal = true" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 text-sm">Trigger Parse</button>
                    </div>
                </div>

                <!-- Live Progress Banner -->
                <div x-show="parserProgress?.running" class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                    <template x-for="job in parserProgress?.jobs || []" :key="job.id">
                        <div class="mb-4 last:mb-0">
                            <div class="flex justify-between items-center mb-2">
                                <div class="flex items-center gap-2">
                                    <div class="w-3 h-3 rounded-full animate-pulse" :class="job.status === 'running' ? 'bg-green-500' : job.status === 'paused' ? 'bg-yellow-500' : 'bg-gray-500'"></div>
                                    <span class="font-semibold" x-text="job.job_type + ' - ' + (job.scope.region || 'All regions')"></span>
                                    <span class="text-sm text-gray-500" x-text="'(' + job.status + ')'"></span>
                                </div>
                                <div class="flex gap-2">
                                    <button x-show="job.status === 'running'" @click="controlJob(job.id, 'pause')" class="text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded hover:bg-yellow-200">Pause</button>
                                    <button x-show="job.status === 'paused'" @click="controlJob(job.id, 'resume')" class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded hover:bg-green-200">Resume</button>
                                    <button x-show="job.status !== 'stopping'" @click="controlJob(job.id, 'stop')" class="text-xs bg-red-100 text-red-800 px-2 py-1 rounded hover:bg-red-200">Stop</button>
                                </div>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div class="bg-blue-600 h-2 rounded-full transition-all" :style="'width: ' + job.progress.percentage + '%'"></div>
                            </div>
                            <div class="flex justify-between text-xs text-gray-500 mt-1">
                                <span x-text="job.progress.processed + '/' + job.progress.total + ' items'"></span>
                                <span x-text="'New: ' + job.progress.new + ' | Updated: ' + job.progress.updated + ' | Skipped: ' + job.progress.skipped"></span>
                                <span x-text="job.current.region ? 'Current: ' + job.current.region + ' p' + job.current.page : ''"></span>
                            </div>
                        </div>
                    </template>
                </div>

                <!-- Parser Tabs -->
                <div class="mb-4 border-b">
                    <nav class="flex gap-4">
                        <button @click="parserTab = 'stats'" :class="parserTab === 'stats' ? 'border-b-2 border-blue-500 text-blue-600' : 'text-gray-500'" class="pb-2 px-1 text-sm font-medium">Statistics</button>
                        <button @click="parserTab = 'jobs'; loadParserJobs()" :class="parserTab === 'jobs' ? 'border-b-2 border-blue-500 text-blue-600' : 'text-gray-500'" class="pb-2 px-1 text-sm font-medium">Job History</button>
                        <button @click="parserTab = 'config'; loadParserConfig()" :class="parserTab === 'config' ? 'border-b-2 border-blue-500 text-blue-600' : 'text-gray-500'" class="pb-2 px-1 text-sm font-medium">Configuration</button>
                    </nav>
                </div>

                <div x-show="loading" class="flex justify-center py-8"><div class="loader"></div></div>

                <!-- Stats Tab -->
                <div x-show="!loading && parserTab === 'stats'" class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div class="bg-white rounded-lg shadow p-6">
                            <div class="text-gray-500 text-sm">Total Jobs</div>
                            <div class="text-3xl font-bold" x-text="parserStats?.total_jobs || 0"></div>
                        </div>
                        <div class="bg-white rounded-lg shadow p-6">
                            <div class="text-gray-500 text-sm">Parsed Today</div>
                            <div class="text-3xl font-bold text-blue-600" x-text="parserStats?.parsed_today || 0"></div>
                        </div>
                        <div class="bg-white rounded-lg shadow p-6">
                            <div class="text-gray-500 text-sm">Parse Jobs (7d)</div>
                            <div class="text-3xl font-bold text-green-600" x-text="parserStats?.parse_jobs_7d?.completed || 0"></div>
                            <div class="text-xs text-gray-400" x-text="parserStats?.parse_jobs_7d?.failed + ' failed'"></div>
                        </div>
                        <div class="bg-white rounded-lg shadow p-6">
                            <div class="text-gray-500 text-sm">New Items (7d)</div>
                            <div class="text-3xl font-bold text-purple-600" x-text="parserStats?.parse_jobs_7d?.new_items || 0"></div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="bg-white rounded-lg shadow p-6">
                            <h3 class="font-bold mb-4">By Region</h3>
                            <div class="space-y-2 max-h-64 overflow-auto">
                                <template x-for="region in parserStats?.by_region || []" :key="region.slug">
                                    <div class="flex justify-between py-1 border-b">
                                        <span class="text-gray-600" x-text="region.name_en"></span>
                                        <span class="font-semibold" x-text="region.count"></span>
                                    </div>
                                </template>
                            </div>
                        </div>
                        <div class="bg-white rounded-lg shadow p-6">
                            <h3 class="font-bold mb-4">By Category</h3>
                            <div class="space-y-2 max-h-64 overflow-auto">
                                <template x-for="cat in parserStats?.by_category || []" :key="cat.slug">
                                    <div class="flex justify-between py-1 border-b">
                                        <span class="text-gray-600" x-text="cat.name_en"></span>
                                        <span class="font-semibold" x-text="cat.count"></span>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>

                    <!-- Skip Reasons -->
                    <div x-show="parserStats?.skip_reasons_7d?.length > 0" class="bg-white rounded-lg shadow p-6">
                        <h3 class="font-bold mb-4">Skip Reasons (7 days)</h3>
                        <div class="flex flex-wrap gap-2">
                            <template x-for="reason in parserStats?.skip_reasons_7d || []" :key="reason.reason">
                                <span class="px-3 py-1 bg-gray-100 rounded-full text-sm">
                                    <span x-text="reason.reason"></span>: <span class="font-semibold" x-text="reason.count"></span>
                                </span>
                            </template>
                        </div>
                    </div>
                </div>

                <!-- Jobs Tab -->
                <div x-show="!loading && parserTab === 'jobs'" class="space-y-4">
                    <div class="bg-white rounded-lg shadow overflow-hidden">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-sm font-semibold">Status</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold">Type/Scope</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold">Progress</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold">Results</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold">Time</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y">
                                <template x-for="job in parserJobs?.jobs || []" :key="job.id">
                                    <tr class="hover:bg-gray-50">
                                        <td class="px-4 py-3">
                                            <span class="px-2 py-1 text-xs rounded-full"
                                                :class="{
                                                    'bg-green-100 text-green-800': job.status === 'completed',
                                                    'bg-blue-100 text-blue-800': job.status === 'running',
                                                    'bg-yellow-100 text-yellow-800': job.status === 'paused',
                                                    'bg-red-100 text-red-800': job.status === 'failed' || job.status === 'cancelled',
                                                    'bg-gray-100 text-gray-800': job.status === 'pending'
                                                }" x-text="job.status"></span>
                                        </td>
                                        <td class="px-4 py-3 text-sm">
                                            <div class="font-medium" x-text="job.job_type"></div>
                                            <div class="text-xs text-gray-500" x-text="(job.scope.region || 'all') + ' / ' + (job.scope.category || 'all')"></div>
                                        </td>
                                        <td class="px-4 py-3">
                                            <div class="w-24 bg-gray-200 rounded-full h-2">
                                                <div class="bg-blue-600 h-2 rounded-full" :style="'width: ' + job.progress.percentage + '%'"></div>
                                            </div>
                                            <div class="text-xs text-gray-500 mt-1" x-text="job.progress.processed + '/' + job.progress.total"></div>
                                        </td>
                                        <td class="px-4 py-3 text-xs">
                                            <span class="text-green-600" x-text="'New: ' + job.progress.new"></span>
                                            <span class="text-blue-600 ml-2" x-text="'Upd: ' + job.progress.updated"></span>
                                            <span class="text-gray-500 ml-2" x-text="'Skip: ' + job.progress.skipped"></span>
                                        </td>
                                        <td class="px-4 py-3 text-xs text-gray-500" x-text="job.timing.created_at?.split('T')[0]"></td>
                                        <td class="px-4 py-3">
                                            <button @click="viewJobDetails(job.id)" class="text-blue-600 hover:underline text-xs mr-2">Details</button>
                                            <button x-show="job.controls.can_restart" @click="controlJob(job.id, 'restart')" class="text-green-600 hover:underline text-xs">Restart</button>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Config Tab -->
                <div x-show="!loading && parserTab === 'config'" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white rounded-lg shadow p-6">
                        <h3 class="font-bold mb-4">Regions</h3>
                        <div class="space-y-2 max-h-96 overflow-auto">
                            <template x-for="region in parserConfig?.regions || []" :key="region.id">
                                <div class="flex justify-between items-center py-1 border-b">
                                    <div>
                                        <span class="font-medium" x-text="region.name_en"></span>
                                        <span class="text-sm text-gray-500 ml-2" x-text="region.name_ge"></span>
                                    </div>
                                    <span class="px-2 py-1 text-xs rounded" :class="region.enabled ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-500'" x-text="region.enabled ? 'Active' : 'Inactive'"></span>
                                </div>
                            </template>
                        </div>
                    </div>
                    <div class="bg-white rounded-lg shadow p-6">
                        <h3 class="font-bold mb-4">Categories</h3>
                        <div class="space-y-2 max-h-96 overflow-auto">
                            <template x-for="cat in parserConfig?.categories || []" :key="cat.id">
                                <div class="py-1 border-b">
                                    <span class="font-medium" x-text="cat.name_en"></span>
                                    <span class="text-sm text-gray-500 ml-2" x-text="cat.name_ge"></span>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Trigger Parse Modal -->
            <div x-show="showTriggerModal" x-cloak class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md" @click.outside="showTriggerModal = false">
                    <h3 class="text-lg font-bold mb-4">Trigger Parse Job</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-1">Region (optional)</label>
                            <select x-model="triggerForm.region" class="w-full border rounded px-3 py-2">
                                <option value="">All Regions</option>
                                <template x-for="region in parserConfig?.regions || []" :key="region.slug">
                                    <option :value="region.slug" x-text="region.name_en"></option>
                                </template>
                            </select>
                        </div>
                        <div class="flex justify-end gap-2">
                            <button @click="showTriggerModal = false" class="px-4 py-2 border rounded hover:bg-gray-100">Cancel</button>
                            <button @click="triggerParse()" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Start Parse</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Job Details Modal -->
            <div x-show="showJobModal" x-cloak class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-4xl max-h-[80vh] overflow-auto" @click.outside="showJobModal = false">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold">Job Details</h3>
                        <button @click="showJobModal = false" class="text-gray-500 hover:text-gray-700">&times;</button>
                    </div>
                    <div x-show="selectedJob">
                        <div class="grid grid-cols-3 gap-4 mb-4">
                            <div class="bg-gray-50 p-3 rounded">
                                <div class="text-xs text-gray-500">Status</div>
                                <div class="font-semibold" x-text="selectedJob?.status"></div>
                            </div>
                            <div class="bg-gray-50 p-3 rounded">
                                <div class="text-xs text-gray-500">Progress</div>
                                <div class="font-semibold" x-text="selectedJob?.progress?.processed + '/' + selectedJob?.progress?.total"></div>
                            </div>
                            <div class="bg-gray-50 p-3 rounded">
                                <div class="text-xs text-gray-500">New/Updated</div>
                                <div class="font-semibold" x-text="selectedJob?.progress?.new + ' / ' + selectedJob?.progress?.updated"></div>
                            </div>
                        </div>

                        <!-- Tabs -->
                        <div class="border-b mb-4">
                            <nav class="flex gap-4">
                                <button @click="jobDetailTab = 'logs'" :class="jobDetailTab === 'logs' ? 'border-b-2 border-blue-500' : ''" class="pb-2 px-1 text-sm">Logs</button>
                                <button @click="jobDetailTab = 'items'" :class="jobDetailTab === 'items' ? 'border-b-2 border-blue-500' : ''" class="pb-2 px-1 text-sm">Items</button>
                                <button @click="jobDetailTab = 'skips'" :class="jobDetailTab === 'skips' ? 'border-b-2 border-blue-500' : ''" class="pb-2 px-1 text-sm">Skip Reasons</button>
                            </nav>
                        </div>

                        <!-- Logs Tab -->
                        <div x-show="jobDetailTab === 'logs'" class="max-h-64 overflow-auto bg-gray-900 text-gray-100 p-3 rounded font-mono text-xs">
                            <template x-for="log in selectedJob?.logs || []" :key="log.id">
                                <div class="mb-1">
                                    <span :class="{'text-red-400': log.level === 'error', 'text-yellow-400': log.level === 'warning', 'text-blue-400': log.level === 'info'}" x-text="'[' + log.level + ']'"></span>
                                    <span class="text-gray-400" x-text="log.created_at?.split('T')[1]?.split('.')[0]"></span>
                                    <span x-text="log.message"></span>
                                </div>
                            </template>
                            <div x-show="!selectedJob?.logs?.length" class="text-gray-500">No logs available</div>
                        </div>

                        <!-- Items Tab -->
                        <div x-show="jobDetailTab === 'items'" class="max-h-64 overflow-auto">
                            <table class="w-full text-xs">
                                <thead class="bg-gray-50 sticky top-0">
                                    <tr>
                                        <th class="px-2 py-1 text-left">ID</th>
                                        <th class="px-2 py-1 text-left">Title</th>
                                        <th class="px-2 py-1 text-left">Result</th>
                                        <th class="px-2 py-1 text-left">Skip</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y">
                                    <template x-for="item in selectedJob?.items || []" :key="item.id">
                                        <tr>
                                            <td class="px-2 py-1" x-text="item.external_id"></td>
                                            <td class="px-2 py-1 truncate max-w-xs" x-text="item.title"></td>
                                            <td class="px-2 py-1">
                                                <span class="px-1 rounded text-xs" :class="{'bg-green-100': item.result === 'new', 'bg-blue-100': item.result === 'updated', 'bg-gray-100': item.result === 'skipped'}" x-text="item.result"></span>
                                            </td>
                                            <td class="px-2 py-1 text-gray-500" x-text="item.skip_reason || '-'"></td>
                                        </tr>
                                    </template>
                                </tbody>
                            </table>
                            <div x-show="!selectedJob?.items?.length" class="text-gray-500 py-4 text-center">No items recorded</div>
                        </div>

                        <!-- Skip Reasons Tab -->
                        <div x-show="jobDetailTab === 'skips'" class="space-y-2">
                            <template x-for="reason in selectedJob?.skipReasons || []" :key="reason.reason">
                                <div class="flex justify-between py-2 border-b">
                                    <span x-text="reason.reason"></span>
                                    <span class="font-semibold" x-text="reason.count"></span>
                                </div>
                            </template>
                            <div x-show="!selectedJob?.skipReasons?.length" class="text-gray-500 py-4 text-center">No skip reasons</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Analytics Page -->
            <div x-show="currentPage === 'analytics'" x-cloak class="p-6">
                <h2 class="text-2xl font-bold mb-6">Analytics</h2>

                <div x-show="loading" class="flex justify-center py-8"><div class="loader"></div></div>

                <div x-show="!loading && analyticsData" class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div class="bg-white rounded-lg shadow p-6">
                            <div class="text-gray-500 text-sm">Total Jobs</div>
                            <div class="text-3xl font-bold" x-text="analyticsData?.overview?.total_jobs || 0"></div>
                        </div>
                        <div class="bg-white rounded-lg shadow p-6">
                            <div class="text-gray-500 text-sm">With Salary</div>
                            <div class="text-3xl font-bold text-green-600" x-text="analyticsData?.overview?.with_salary || 0"></div>
                        </div>
                        <div class="bg-white rounded-lg shadow p-6">
                            <div class="text-gray-500 text-sm">Avg Min Salary</div>
                            <div class="text-3xl font-bold text-blue-600" x-text="(analyticsData?.salary?.average?.min || 0) + ' GEL'"></div>
                        </div>
                        <div class="bg-white rounded-lg shadow p-6">
                            <div class="text-gray-500 text-sm">Avg Max Salary</div>
                            <div class="text-3xl font-bold text-purple-600" x-text="(analyticsData?.salary?.average?.max || 0) + ' GEL'"></div>
                        </div>
                    </div>

                    <div class="bg-white rounded-lg shadow p-6">
                        <h3 class="font-bold mb-4">Top Companies</h3>
                        <div class="space-y-2">
                            <template x-for="company in analyticsData?.trends?.top_companies || []" :key="company.company">
                                <div class="flex justify-between py-1 border-b">
                                    <span class="text-gray-600" x-text="company.company"></span>
                                    <span class="font-semibold" x-text="company.count + ' jobs'"></span>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Backups Page -->
            <div x-show="currentPage === 'backups'" x-cloak class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">Backups</h2>
                    <button @click="createBackup()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Create Backup</button>
                </div>

                <div x-show="loading" class="flex justify-center py-8"><div class="loader"></div></div>

                <div x-show="!loading" class="space-y-6">
                    <!-- Status -->
                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="flex items-center mb-4">
                            <span class="w-3 h-3 rounded-full mr-2" :class="backupStatus?.health === 'healthy' ? 'bg-green-500' : backupStatus?.health === 'warning' ? 'bg-yellow-500' : 'bg-red-500'"></span>
                            <span class="font-bold" x-text="backupStatus?.health || 'Unknown'"></span>
                        </div>
                        <p class="text-gray-600" x-text="backupStatus?.message"></p>
                        <div class="mt-4 text-sm text-gray-500">
                            <span x-text="'Total: ' + (backupStatus?.count || 0) + ' backups'"></span>
                            <span class="ml-4" x-text="'Size: ' + (backupStatus?.total_size_mb || 0) + ' MB'"></span>
                        </div>
                    </div>

                    <!-- Backup List -->
                    <div class="bg-white rounded-lg shadow overflow-hidden">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-sm font-semibold">Name</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold">Type</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold">Size</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold">Created</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y">
                                <template x-for="backup in backups?.backups || []" :key="backup.name">
                                    <tr class="hover:bg-gray-50">
                                        <td class="px-4 py-3 font-medium" x-text="backup.name"></td>
                                        <td class="px-4 py-3">
                                            <span class="px-2 py-1 text-xs rounded-full bg-gray-100" x-text="backup.type"></span>
                                        </td>
                                        <td class="px-4 py-3 text-sm" x-text="backup.size_mb + ' MB'"></td>
                                        <td class="px-4 py-3 text-sm" x-text="backup.created_at"></td>
                                        <td class="px-4 py-3">
                                            <a :href="'/api/backups/' + backup.path" class="text-blue-600 hover:underline text-sm">Download</a>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Database Page -->
            <div x-show="currentPage === 'database'" x-cloak class="p-6">
                <h2 class="text-2xl font-bold mb-6">Database Browser</h2>

                <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
                    <!-- Tables List -->
                    <div class="bg-white rounded-lg shadow p-4">
                        <h3 class="font-bold mb-4">Tables</h3>
                        <div x-show="loading" class="flex justify-center py-4"><div class="loader"></div></div>
                        <div x-show="!loading" class="space-y-2">
                            <template x-for="table in dbTables?.tables || []" :key="table.name">
                                <button @click="loadTable(table.name)" class="w-full text-left px-3 py-2 rounded hover:bg-gray-100" :class="selectedTable === table.name ? 'bg-blue-100' : ''">
                                    <div class="font-medium" x-text="table.name"></div>
                                    <div class="text-xs text-gray-500" x-text="table.row_count + ' rows'"></div>
                                </button>
                            </template>
                        </div>
                    </div>

                    <!-- Table Data -->
                    <div class="lg:col-span-3 bg-white rounded-lg shadow p-4">
                        <div x-show="!selectedTable" class="text-gray-500 py-8 text-center">Select a table to view data</div>
                        <div x-show="selectedTable">
                            <h3 class="font-bold mb-4" x-text="selectedTable"></h3>

                            <!-- Columns -->
                            <div class="mb-4 text-sm">
                                <span class="font-semibold">Columns: </span>
                                <span x-text="tableInfo?.columns?.map(c => c.name).join(', ')"></span>
                            </div>

                            <!-- Sample Data -->
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <template x-for="col in tableInfo?.columns?.slice(0, 6) || []" :key="col.name">
                                                <th class="px-2 py-2 text-left" x-text="col.name"></th>
                                            </template>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y">
                                        <template x-for="(row, idx) in tableInfo?.sample_rows || []" :key="idx">
                                            <tr>
                                                <template x-for="col in tableInfo?.columns?.slice(0, 6) || []" :key="col.name">
                                                    <td class="px-2 py-2 truncate max-w-xs" x-text="row[col.name]"></td>
                                                </template>
                                            </tr>
                                        </template>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Query Box -->
                        <div class="mt-6 pt-6 border-t">
                            <h4 class="font-bold mb-2">Run Query (SELECT only)</h4>
                            <textarea x-model="sqlQuery" class="w-full border rounded p-2 font-mono text-sm" rows="3" placeholder="SELECT * FROM jobs LIMIT 10"></textarea>
                            <button @click="runQuery()" class="mt-2 bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Run</button>

                            <div x-show="queryResult" class="mt-4 overflow-x-auto">
                                <div class="text-sm text-gray-500 mb-2" x-text="'Rows: ' + (queryResult?.row_count || 0)"></div>
                                <table class="w-full text-sm">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <template x-for="col in queryResult?.columns || []" :key="col">
                                                <th class="px-2 py-2 text-left" x-text="col"></th>
                                            </template>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y">
                                        <template x-for="(row, idx) in queryResult?.rows || []" :key="idx">
                                            <tr>
                                                <template x-for="col in queryResult?.columns || []" :key="col">
                                                    <td class="px-2 py-2 truncate max-w-xs" x-text="row[col]"></td>
                                                </template>
                                            </tr>
                                        </template>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Logs Page -->
            <div x-show="currentPage === 'logs'" x-cloak class="p-6">
                <h2 class="text-2xl font-bold mb-6">Container Logs</h2>

                <div class="flex gap-4 mb-6">
                    <select x-model="selectedService" @change="loadLogs()" class="border rounded px-3 py-2">
                        <option value="">Select Service</option>
                        <option value="api">API</option>
                        <option value="worker">Worker (Parser)</option>
                        <option value="db">Database</option>
                        <option value="web">Web (Nginx)</option>
                    </select>
                    <select x-model="logTail" @change="loadLogs()" class="border rounded px-3 py-2">
                        <option value="50">Last 50 lines</option>
                        <option value="100">Last 100 lines</option>
                        <option value="500">Last 500 lines</option>
                    </select>
                    <button @click="loadLogs()" class="bg-gray-200 px-4 py-2 rounded hover:bg-gray-300">Refresh</button>
                </div>

                <div x-show="loading" class="flex justify-center py-8"><div class="loader"></div></div>

                <div x-show="!loading && logs" class="bg-black text-green-400 rounded-lg p-4 font-mono text-sm overflow-auto max-h-[600px]">
                    <template x-for="(line, idx) in logs?.lines || []" :key="idx">
                        <div x-text="line" class="whitespace-pre-wrap"></div>
                    </template>
                    <div x-show="!logs?.lines?.length" class="text-gray-500">No logs available</div>
                </div>
            </div>
        </main>
    </div>

    <script>
        function adminApp() {
            return {
                currentPage: 'dashboard',
                loading: false,
                health: 'checking...',

                // Dashboard
                dashboard: null,

                // Jobs
                jobs: {},
                jobFilters: { page: 1, status: '', cid: '', q: '' },

                // Parser
                parserStats: null,
                parserProgress: null,
                parserJobs: null,
                parserConfig: null,
                parserTab: 'stats',
                showTriggerModal: false,
                showJobModal: false,
                selectedJob: null,
                jobDetailTab: 'logs',
                triggerForm: { region: '' },
                progressInterval: null,

                // Analytics
                analyticsData: null,

                // Backups
                backups: null,
                backupStatus: null,

                // Database
                dbTables: null,
                selectedTable: null,
                tableInfo: null,
                sqlQuery: '',
                queryResult: null,

                // Logs
                selectedService: '',
                logTail: '100',
                logs: null,

                async init() {
                    await this.checkHealth();
                    await this.loadDashboard();
                },

                async api(endpoint, options = {}) {
                    try {
                        const res = await fetch('/api' + endpoint, options);
                        if (!res.ok) throw new Error(`HTTP ${res.status}`);
                        return await res.json();
                    } catch (e) {
                        console.error('API Error:', e);
                        return null;
                    }
                },

                async checkHealth() {
                    const data = await this.api('/health');
                    this.health = data?.status || 'error';
                },

                async loadDashboard() {
                    this.loading = true;
                    this.dashboard = await this.api('/dashboard');
                    this.loading = false;
                },

                async loadJobs() {
                    this.loading = true;
                    const params = new URLSearchParams();
                    params.set('page', this.jobFilters.page);
                    if (this.jobFilters.status) params.set('status', this.jobFilters.status);
                    if (this.jobFilters.cid) params.set('cid', this.jobFilters.cid);
                    if (this.jobFilters.q) params.set('q', this.jobFilters.q);
                    this.jobs = await this.api('/jobs?' + params.toString()) || {};
                    this.loading = false;
                },

                async toggleJobStatus(job) {
                    const newStatus = job.status === 'active' ? 'inactive' : 'active';
                    await this.api(`/jobs/${job.id}/status?status=${newStatus}`, { method: 'PATCH' });
                    await this.loadJobs();
                },

                async deleteJob(id) {
                    if (!confirm('Delete this job?')) return;
                    await this.api(`/jobs/${id}`, { method: 'DELETE' });
                    await this.loadJobs();
                },

                async loadParserStats() {
                    this.loading = true;
                    this.parserStats = await this.api('/parser/stats');
                    this.parserConfig = await this.api('/parser/config');
                    await this.loadParserProgress();
                    this.startProgressPolling();
                    this.loading = false;
                },

                startProgressPolling() {
                    if (this.progressInterval) clearInterval(this.progressInterval);
                    this.progressInterval = setInterval(async () => {
                        if (this.currentPage === 'parser') {
                            await this.loadParserProgress();
                        }
                    }, 5000);
                },

                stopProgressPolling() {
                    if (this.progressInterval) {
                        clearInterval(this.progressInterval);
                        this.progressInterval = null;
                    }
                },

                async loadParserProgress() {
                    this.parserProgress = await this.api('/parser/progress');
                },

                async loadParserJobs() {
                    this.loading = true;
                    this.parserJobs = await this.api('/parser/jobs?limit=50');
                    this.loading = false;
                },

                async loadParserConfig() {
                    this.loading = true;
                    this.parserConfig = await this.api('/parser/config');
                    this.loading = false;
                },

                async controlJob(jobId, action) {
                    await this.api(`/parser/jobs/${jobId}/control`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ action }),
                    });
                    await this.loadParserProgress();
                    if (this.parserTab === 'jobs') await this.loadParserJobs();
                },

                async triggerParse() {
                    const regions = this.triggerForm.region ? [this.triggerForm.region] : null;
                    await this.api('/parser/trigger', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ regions, source: 'jobs.ge' }),
                    });
                    this.showTriggerModal = false;
                    this.triggerForm.region = '';
                    await this.loadParserProgress();
                },

                async viewJobDetails(jobId) {
                    const [job, skipReasons] = await Promise.all([
                        this.api(`/parser/jobs/${jobId}?include_items=true&include_logs=true`),
                        this.api(`/parser/jobs/${jobId}/skip-reasons`),
                    ]);
                    this.selectedJob = { ...job, skipReasons: skipReasons?.skip_reasons || [] };
                    this.jobDetailTab = 'logs';
                    this.showJobModal = true;
                },

                async loadAnalytics() {
                    this.loading = true;
                    const [overview, salary, trends] = await Promise.all([
                        this.api('/analytics/overview'),
                        this.api('/analytics/salary'),
                        this.api('/analytics/trends'),
                    ]);
                    this.analyticsData = { overview, salary, trends };
                    this.loading = false;
                },

                async loadBackups() {
                    this.loading = true;
                    [this.backups, this.backupStatus] = await Promise.all([
                        this.api('/backups'),
                        this.api('/backups/status'),
                    ]);
                    this.loading = false;
                },

                async createBackup() {
                    this.loading = true;
                    await this.api('/backups', { method: 'POST' });
                    await this.loadBackups();
                },

                async loadDbTables() {
                    this.loading = true;
                    this.dbTables = await this.api('/database/tables');
                    this.loading = false;
                },

                async loadTable(name) {
                    this.selectedTable = name;
                    this.tableInfo = await this.api(`/database/tables/${name}`);
                },

                async runQuery() {
                    if (!this.sqlQuery.trim()) return;
                    this.queryResult = await this.api('/database/query', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ sql: this.sqlQuery }),
                    });
                },

                async loadLogs() {
                    if (!this.selectedService) return;
                    this.loading = true;
                    this.logs = await this.api(`/logs/${this.selectedService}?tail=${this.logTail}`);
                    this.loading = false;
                },

                // Watch for page changes
                $watch: {
                    currentPage(page) {
                        this.loading = false;
                        if (page === 'dashboard') this.loadDashboard();
                        else if (page === 'jobs') this.loadJobs();
                        else if (page === 'parser') this.loadParserStats();
                        else if (page === 'analytics') this.loadAnalytics();
                        else if (page === 'backups') this.loadBackups();
                        else if (page === 'database') this.loadDbTables();
                    }
                }
            };
        }
    </script>
</body>
</html>
